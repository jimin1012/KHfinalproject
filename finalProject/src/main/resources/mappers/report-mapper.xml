<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="reportMapper">

	<!-- 신고  -->
	<resultMap type="Report" id="report_rm">
		<id property="userNo" column="USER_NO"/>
		<result property="boardNo" column="BOARD_NO"/>
		<result property="replyNo" column="REPLY_NO"/>
		<result property="reportStFlag" column="REPORT_ST_FL"/>
		<result property="reportContent" column="REPORT_CONTENT"/>	
	</resultMap>
	
	<!-- 게시판 -->
	<resultMap type="Board" id="board_rm">
		<id property="boardNo" column="BOARD_NO"/>
		<result property="boardTitle" column="BOARD_TITLE"/>
		<result property="userNickname" column="USER_NICKNAME"/>
		<result property="boardContent" column="BOARD_CONTENT"/>
		<result property="boardName" column="BOARD_NAME"/>
		<result property="reportStFlag" column="REPORT_ST_FL"/>
		<result property="reportCount" column="REPORT_COUNT"/>
		
		<collection property="reportList" select="selectReportContentB"
			column="BOARD_NO"
			javaType="java.util.ArrayList"
			ofType="Report">
		</collection>
	</resultMap>
	
	<!-- 댓글 -->
	<resultMap type="Comment" id="comment_rm">
		<id property="commentNo" column="COMMENT_NO"/>
		<result property="commentContent" column="COMMENT_CONTENT"/>
		<result property="userNickName" column="USER_NICKNAME"/>
		<result property="boardName" column="BOARD_NAME"/>
		<result property="reportCount" column="REPORT_COUNT"/>
		
		<collection property="reportList" select="selectReportContentC"
			column="COMMENT_NO"
			javaType="java.util.ArrayList"
			ofType="Report">
		</collection>
	</resultMap>
	
	
	
	
	
	
	<!-- 게시글 신고 삽입 -->
	<insert id="insertBoardReport">
		INSERT INTO "REPORT"
		VALUES (#{userNo}, #{boardNo}, NULL, DEFAULT, #{reportContent})
	</insert>
	
	
	<!-- 신고된 게시글 목록 조회 -->
	<select id="selectBaordReportList" resultMap="board_rm">
		SELECT B.BOARD_NO, BOARD_TITLE, BOARD_CONTENT, BOARD_NAME, USER_NICKNAME,
		    (SELECT COUNT(*) FROM "REPORT" R WHERE R.BOARD_NO = B.BOARD_NO) REPORT_COUNT
		FROM BOARD B
		JOIN "USER" USING(USER_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		<choose>
			<when test='state == "wait"'>
				WHERE B.BOARD_NO IN (SELECT BOARD_NO FROM "REPORT" WHERE REPORT_ST_FL = 'W')
			</when>
			<when test='state == "delete"'>
				WHERE B.BOARD_NO IN (SELECT BOARD_NO FROM "REPORT" WHERE REPORT_ST_FL = 'Y')
			</when>
			<when test='state == "cancel"'>
				WHERE B.BOARD_NO IN (SELECT BOARD_NO FROM "REPORT" WHERE REPORT_ST_FL = 'N')
			</when>
			<otherwise>
				WHERE B.BOARD_NO IN (SELECT BOARD_NO FROM "REPORT")
			</otherwise>
		</choose>
		ORDER BY BOARD_NO DESC
	</select>
	
	<!-- 게시글 신고 사유 조회 -->
	<select id="selectReportContentB" resultMap="report_rm">
		SELECT USER_NO, BOARD_NO, REPLY_NO, REPORT_ST_FL, REPORT_CONTENT
		FROM "REPORT"
		WHERE BOARD_NO = #{boardNo}
	</select>
	
	
	<!-- 신고된 게시글 처리 -->
	<update id="updateBoardReportSt">
		UPDATE "REPORT" 
		<if test='state == "cancel"'>
			SET REPORT_ST_FL = 'N'
		</if>
		<if test='state == "delete"'>
			SET REPORT_ST_FL = 'Y'
		</if>
		WHERE BOARD_NO = #{boardNo}
	</update>
	
	<!-- 신고처리된 게시글 삭제 -->
	<update id="deleteBoard">
		UPDATE BOARD SET BOARD_DEL_FL = 'Y'
		WHERE BOARD_NO = #{boardNo}
	</update>
	
	
	<!-- 신고된 댓글 목록 조회 -->
	<select id="selectCommentReportList" resultMap="comment_rm">
		SELECT C.COMMENT_NO, COMMENT_CONTENT, BOARD_NAME, USER_NICKNAME,
		        (SELECT COUNT(*) FROM "REPORT" WHERE REPLY_NO = COMMENT_NO) REPORT_COUNT
		FROM "COMMENT" C
		JOIN "USER" USING(USER_NO)
		JOIN BOARD USING(BOARD_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		<choose>
			<when test='state == "wait"'>
				WHERE C.COMMENT_NO IN (SELECT REPLY_NO FROM "REPORT" WHERE REPORT_ST_FL = 'W')
			</when>
			<when test='state == "delete"'>
				WHERE C.COMMENT_NO IN (SELECT REPLY_NO FROM "REPORT" WHERE REPORT_ST_FL = 'Y')
			</when>
			<when test='state == "cancel"'>
				WHERE C.COMMENT_NO IN (SELECT REPLY_NO FROM "REPORT" WHERE REPORT_ST_FL = 'N')
			</when>
			<otherwise>
				WHERE C.COMMENT_NO IN (SELECT REPLY_NO FROM "REPORT")
			</otherwise>
		</choose>
		ORDER BY COMMENT_NO DESC
	</select>
	
	<!-- 댓글 신고 사유 조회 -->
	<select id="selectReportContentC" resultMap="report_rm">
		SELECT USER_NO, BOARD_NO, REPLY_NO, REPORT_ST_FL, REPORT_CONTENT
		FROM "REPORT"
		WHERE REPLY_NO = #{commentNo}
	</select>
	
	<!-- 신고된 댓글 처리 -->
	<update id="updateCommentReportSt">
		UPDATE "REPORT" 
		<if test='state == "cancel"'>
			SET REPORT_ST_FL = 'N'
		</if>
		<if test='state == "delete"'>
			SET REPORT_ST_FL = 'Y'
		</if>
		WHERE REPLY_NO = #{commentNo}
	</update>
	
	<!-- 신고처리된 댓글 삭제 -->
	<update id="deleteComment">
		UPDATE "COMMENT" SET COMMENT_DEL_FL = 'Y'
		WHERE COMMENT_NO = #{commentNo}
	</update>
	
	
	<!-- 댓글 신고 삽입 -->
	<insert id="insertCommentReport">
		INSERT INTO "REPORT"
		VALUES (#{userNo}, NULL, #{replyNo}, DEFAULT, #{reportContent})
	</insert>
	
	

</mapper>
